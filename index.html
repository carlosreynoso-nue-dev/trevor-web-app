<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUE Trevor Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: #eee; padding: 20px; display: flex; justify-content: center; margin: 0; }
        .container { width: 100%; max-width: 400px; background: #1e1e1e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h1 { color: #00d2ff; margin: 0 0 15px 0; text-align: center; letter-spacing: 1px; }
        
        /* Status Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .badge-state { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color:black; background: #888; text-align: center;}
        .st-chg { background: #00ff00; } 
        .st-dsg { background: #ffcc00; } 
        .st-stb { background: #888; color: white; }

        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-top: 5px; }
        
        .card { background: #2c2c2c; padding: 15px; border-radius: 8px; text-align: center; }
        
        /* Typography */
        .label { display: block; font-size: 0.7rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .value { font-size: 1.3rem; font-weight: bold; color: #fff; }
        .value-sm { font-size: 1.0rem; font-weight: bold; color: #fff; }
        .unit { font-size: 0.8rem; color: #888; font-weight: normal; }
        
        /* GPS Link */
        #mapLink { color: #00d2ff; text-decoration: none; font-size: 0.85rem; font-weight: bold; display: none; margin-top: 8px; border: 1px solid #00d2ff; padding: 5px; border-radius: 4px; }
        
        /* Buttons */
        .hidden { display: none; }
        button { width: 100%; background: #00d2ff; border: none; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1rem; margin-top: 15px; cursor: pointer; color: #000; }
        button.secondary { background: #444; color: white; margin-top: 10px; }
        button:active { opacity: 0.8; }
        
        /* Config Inputs */
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; background: #181818; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }

        .alarm { color: #ff4444; font-weight: bold; background: rgba(255,0,0,0.1); padding: 5px; border-radius: 4px; margin-top: 5px; font-size: 0.85rem;}
        .healthy { color: #00d2ff; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="connectScreen">
        <h1>NUE TREVOR</h1>
        <p style="text-align:center; color:#888;">Edge Provisioning Tool</p>
        <button id="btnConnect">CONNECT VIA BLUETOOTH</button>
        <p id="statusMsg" style="text-align:center; color:#666; margin-top:20px; font-size:0.8rem;">Ready</p>
    </div>

    <div id="dashboardScreen" class="hidden">
        <div class="header">
            <span style="font-weight:bold; color:#00d2ff;">DASHBOARD</span>
            <span id="sysState" class="badge-state st-stb">--</span>
        </div>
        
        <div class="card" style="margin-bottom:10px; border-left: 4px solid #00d2ff;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="label" style="margin:0;">REMOTE LINK (LTE)</span>
                <div id="lte_rssi" style="font-size:0.8rem; color:#888; font-weight:bold;">--</div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                <div style="text-align:left;">
                    <span class="label">NETWORK</span>
                    <div id="lte_net" style="font-weight:bold; color:#fff;">Searching...</div>
                </div>
                <div style="text-align:right;">
                    <span class="label">CLOUD SYNC</span>
                    <div id="mqtt_stat" class="badge-state st-stb">WAITING...</div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <span class="label">Voltage</span>
                <span id="v" class="value">--</span> <span class="unit">V</span>
            </div>
            <div class="card">
                <span class="label">EST. RUN TIME</span>
                <div id="runtime" class="value" style="color:#00d2ff;">--:--</div> 
                <div style="font-size:0.8rem; color:#888;">
                    <span id="i">0.0</span> A / <span id="pwr">0</span> W
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom:10px;">
             <span class="label">STATE OF CHARGE</span>
             <span id="soc" class="value" style="font-size: 2rem;">--</span> <span class="unit">%</span>
        </div>
        
        <div class="card">
            <span class="label" style="margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px;">BATTERY HEALTH</span>
            <div class="grid-4">
                <div><span class="label">LOW</span><div id="c_min" class="value-sm">--</div></div>
                <div><span class="label">HIGH</span><div id="c_max" class="value-sm">--</div></div>
                <div><span class="label">AVG</span><div id="c_avg" class="value-sm">--</div></div>
                <div><span class="label">CYCLES</span><div id="cyc" class="value-sm" style="color:#ffcc00">--</div></div>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; color:#888;">
                Delta: <span id="c_delta" style="color:#fff; font-weight:bold;">--</span> V
            </div>
        </div>

        <div class="card" style="margin-top:10px;">
            <span class="label">SYSTEM STATUS</span>
            <div id="alarms"><span class="healthy">Waiting for Update...</span></div>
        </div>

        <button id="btnSettings" class="secondary">‚öôÔ∏è PROVISIONING SETTINGS</button>
        <button onclick="location.reload()" style="background:#333; color:#fff;">DISCONNECT</button>
    </div>

    <div id="configScreen" class="hidden">
        <h1>PROVISIONING</h1>
        
        <label class="label" style="text-align:left">Target Battery (MAC)</label>
        <select id="bmsList"><option>Scanning...</option></select>

        <label class="label" style="text-align:left">Device ID / Serial Number</label>
        <input type="text" id="devid" placeholder="e.g. 1234567890">

        <label class="label" style="text-align:left">Flespi Token</label>
        <input type="password" id="token">

        <label class="label" style="text-align:left">APN</label>
        <input type="text" id="apn">
        
        <div style="background:#333; padding:10px; border-radius:6px; margin-bottom:15px;">
            <p style="font-size:0.75rem; color:#aaa; margin:0 0 5px 0;">ADVANCED CLOUD SETTINGS</p>
            <label class="label" style="text-align:left">MQTT Broker</label>
            <input type="text" id="broker" placeholder="mqtt.flespi.io" style="margin-bottom:5px;">
            <label class="label" style="text-align:left">MQTT Port</label>
            <input type="number" id="port" placeholder="1883" style="margin-bottom:0;">
        </div>

        <button id="btnSave" style="background:#00ff00; color:#000;">SAVE & REBOOT</button>
        <button id="btnBack" class="secondary">Cancel</button>
    </div>
</div>

<script>
    const SVC_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHAR_SETTINGS = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const CHAR_SCAN = "1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";
    const CHAR_CMD = "748db82d-2276-440c-a25c-2562945b4270";
    const CHAR_FAST = "d05f38b4-0469-4d0c-9bc4-245745c05f53";
    const CHAR_DETAIL = "e23e78a0-4e6c-4e27-b2f3-4e2342349122";

    let device, server, service, settingsChar, cmdChar;

    // --- UI SWITCHER ---
    function showScreen(id) {
        ['connectScreen', 'dashboardScreen', 'configScreen'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    // --- CONNECT ---
    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            document.getElementById('statusMsg').innerText = "Scanning...";
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'NUE_TREVOR_SETUP' }],
                optionalServices: [SVC_UUID]
            });
            device.addEventListener('gattserverdisconnected', () => location.reload());
            
            server = await device.gatt.connect();
            service = await server.getPrimaryService(SVC_UUID);

            const fastChar = await service.getCharacteristic(CHAR_FAST);
            await fastChar.startNotifications();
            fastChar.addEventListener('characteristicvaluechanged', handleFast);

            const detailChar = await service.getCharacteristic(CHAR_DETAIL);
            await detailChar.startNotifications();
            detailChar.addEventListener('characteristicvaluechanged', handleDetail);

            settingsChar = await service.getCharacteristic(CHAR_SETTINGS);
            cmdChar = await service.getCharacteristic(CHAR_CMD);

            showScreen('dashboardScreen');
        } catch(e) {
            document.getElementById('statusMsg').innerText = "Error: " + e.message;
        }
    });

    // --- FAST TELEMETRY (1s) ---
    function handleFast(e) {
        const clean = new TextDecoder().decode(e.target.value).replace(/\0/g, '').trim();
        try {
            const d = JSON.parse(clean);
            
            // 1. Update Connectivity Card
            if (d.net !== undefined) {
                document.getElementById('lte_net').innerText = d.net;
                document.getElementById('lte_rssi').innerText = "Sig: " + d.sig;
                
                const mqttEl = document.getElementById('mqtt_stat');
                if (d.mqtt === 1) {
                    mqttEl.innerText = "ONLINE ‚òÅÔ∏è";
                    mqttEl.className = "badge-state st-chg";
                } else {
                    mqttEl.innerText = "OFFLINE ‚ùå";
                    mqttEl.className = "badge-state st-dsg";
                }
            }

            // 2. Update Basic Vitals
            if(d.v !== undefined) document.getElementById('v').innerText = d.v.toFixed(1);
            if(d.soc !== undefined) document.getElementById('soc').innerText = d.soc;
            
            // State Badge
            const stEl = document.getElementById('sysState');
            if (d.con === 1) {
                if (d.i > 0.5) { stEl.innerText = "DISCHARGING üîã"; stEl.className = "badge-state st-dsg"; }
                else if (d.i < -0.5) { stEl.innerText = "CHARGING ‚ö°"; stEl.className = "badge-state st-chg"; }
                else { stEl.innerText = "STANDBY üí§"; stEl.className = "badge-state st-stb"; }
            } else {
                stEl.innerText = "BMS DISCONNECTED"; stEl.className = "badge-state st-dsg";
            }

            // 3. Autonomy Math (Run Time Predictor)
            if(d.i !== undefined && d.soc !== undefined && d.v !== undefined) {
                document.getElementById('i').innerText = d.i.toFixed(1);
                const pwr = (d.v * d.i).toFixed(0);
                document.getElementById('pwr').innerText = pwr;

                // Assuming a default 50Ah capacity for the math if not provided yet
                const BATTERY_AH = 50; 
                const remainingAh = BATTERY_AH * (d.soc / 100.0);

                if (d.i > 0.5) { 
                    const hours = Math.floor(remainingAh / d.i);
                    const mins = Math.floor((remainingAh / d.i - hours) * 60);
                    document.getElementById('runtime').innerText = `${hours}h ${mins}m`;
                    document.getElementById('runtime').style.color = "#00d2ff";
                } else {
                    document.getElementById('runtime').innerText = "--:--";
                    document.getElementById('runtime').style.color = "#888";
                }
            }

        } catch(err) { console.error(err); }
    }

    // --- DETAIL TELEMETRY (4s) ---
    function handleDetail(e) {
        const clean = new TextDecoder().decode(e.target.value).replace(/\0/g, '').trim();
        try {
            const d = JSON.parse(clean);

            if(d.cyc !== undefined) document.getElementById('cyc').innerText = d.cyc;
            
            if(d.al) {
                const alDiv = document.getElementById('alarms');
                let active = [];
                if(d.al.ov) active.push("Cell Overvolt");
                if(d.al.uv) active.push("Cell Undervolt");
                if(d.al.sc) active.push("Short Circuit");
                if(d.al.doc) active.push("Discharge Overcurrent");
                if(d.al.cot) active.push("Charge Temp High");
                if(d.al.cut) active.push("Charge Temp Low");
                
                if(active.length > 0) {
                    alDiv.innerHTML = active.map(a => `<div class="alarm">${a}</div>`).join("");
                } else {
                    alDiv.innerHTML = "<span class='healthy'>System Healthy</span>";
                }
            }

            if(d.cel) {
                const cells = d.cel.split(',').filter(x => x).map(Number);
                if(cells.length > 0) {
                    const min = Math.min(...cells);
                    const max = Math.max(...cells);
                    const avg = cells.reduce((a,b) => a+b, 0) / cells.length;
                    const delta = max - min;

                    document.getElementById('c_min').innerText = min.toFixed(3);
                    document.getElementById('c_max').innerText = max.toFixed(3);
                    document.getElementById('c_avg').innerText = avg.toFixed(3);
                    
                    const deltaEl = document.getElementById('c_delta');
                    deltaEl.innerText = delta.toFixed(3);
                    if(delta > 0.100) deltaEl.style.color = "#ff4444"; else deltaEl.style.color = "#00d2ff";
                }
            }
        } catch(err) { console.error(err); }
    }

    // --- SETTINGS / PROVISIONING ---
    document.getElementById('btnSettings').addEventListener('click', async () => {
        showScreen('configScreen');
        
        // Request new scan
        await cmdChar.writeValue(new TextEncoder().encode("SCAN"));
        
        setTimeout(async () => {
            const scanChar = await service.getCharacteristic(CHAR_SCAN);
            const scanVal = await scanChar.readValue();
            const clean = new TextDecoder().decode(scanVal).replace(/\0/g, '').trim();
            const devices = JSON.parse(clean);
            const sel = document.getElementById('bmsList');
            sel.innerHTML = "<option value=''>Select Battery...</option>";
            devices.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.mac; opt.text = `${d.name} (${d.rssi})`;
                sel.add(opt);
            });
            
            // Load existing settings
            const setVal = await settingsChar.readValue();
            const setJson = JSON.parse(new TextDecoder().decode(setVal).replace(/\0/g, '').trim());
            document.getElementById('apn').value = setJson.apn || "";
            document.getElementById('token').value = setJson.token || "";
            document.getElementById('bmsList').value = setJson.mac || "";
            
            // NEW Dynamic Provisioning Fields
            document.getElementById('devid').value = setJson.devid || "";
            document.getElementById('broker').value = setJson.broker || "mqtt.flespi.io";
            document.getElementById('port').value = setJson.port || 1883;

        }, 2500);
    });

    document.getElementById('btnBack').addEventListener('click', () => showScreen('dashboardScreen'));

    document.getElementById('btnSave').addEventListener('click', async () => {
        const data = {
            apn: document.getElementById('apn').value,
            token: document.getElementById('token').value,
            mac: document.getElementById('bmsList').value,
            devid: document.getElementById('devid').value,
            broker: document.getElementById('broker').value,
            port: parseInt(document.getElementById('port').value)
        };
        try {
            await settingsChar.writeValue(new TextEncoder().encode(JSON.stringify(data)));
            await cmdChar.writeValue(new TextEncoder().encode("REBOOT"));
            alert("Settings saved! TREVOR is rebooting to apply new configuration.");
            location.reload();
        } catch(e) { alert("Error: " + e.message); }
    });
</script>
</body>
</html>
