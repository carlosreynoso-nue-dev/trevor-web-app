<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUE Trevor HMI</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; background: #1e1e1e; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { color: #00d2ff; margin: 0; font-size: 1.5rem; letter-spacing: 1px; }
        .badge { background: #333; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge.ok { background: #00d2ff; color: black; }
        
        /* Dashboard Grid */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .card { background: #2c2c2c; padding: 15px; border-radius: 10px; text-align: center; }
        .label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 5px; }
        .value { font-size: 1.4rem; font-weight: bold; color: #fff; }
        .unit { font-size: 0.9rem; color: #888; }
        
        /* Full Width Card */
        .card.full { grid-column: span 2; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .card.full .value { font-size: 1.1rem; }

        /* Forms & Buttons */
        .hidden { display: none; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; background: #181818; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; margin-top: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
        .btn-primary { background-color: #00d2ff; color: #000; }
        .btn-secondary { background-color: #444; color: #fff; margin-top: 10px; }
        
        /* Connection Screen */
        #connectScreen { text-align: center; padding: 40px 0; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="connectScreen">
        <h1>NUE TREVOR</h1>
        <p style="color:#888; margin-bottom: 30px;">Asset Tracker HMI</p>
        <button id="btnConnect" class="btn-primary">Connect via Bluetooth</button>
        <p id="statusMsg" style="margin-top:20px; font-size:0.9em; color:#666;">Ready to connect.</p>
    </div>

    <div id="dashboardScreen" class="hidden">
        <div class="header">
            <h1>NUE</h1>
            <span id="statusBadge" class="badge">LINKED</span>
        </div>

        <div class="grid">
            <div class="card">
                <span class="label">VOLTAGE</span>
                <span id="val_v" class="value">--</span> <span class="unit">V</span>
            </div>
            <div class="card">
                <span class="label">BATTERY</span>
                <span id="val_soc" class="value">--</span> <span class="unit">%</span>
            </div>
        </div>

        <div class="card full">
            <div>
                <span class="label">GPS LOCATION</span>
                <div id="val_gps" class="value" style="font-size: 0.9rem; margin-top:4px;">Searching...</div>
            </div>
            <div id="icon_gps">üì°</div>
        </div>

        <div class="card full">
            <div>
                <span class="label">NETWORK / MAC</span>
                <div id="val_net" class="value" style="font-size: 0.9rem; margin-top:4px;">Init...</div>
            </div>
        </div>

        <button id="btnSettings" class="btn-secondary">‚öôÔ∏è Configure Settings</button>
    </div>

    <div id="configScreen" class="hidden">
        <h3>CONFIGURATION</h3>
        
        <label>Target Battery (MAC)</label>
        <select id="bmsList">
            <option value="">Loading scan...</option>
        </select>

        <label>Cellular APN</label>
        <input type="text" id="apn" placeholder="teal">

        <label>MQTT Token</label>
        <input type="password" id="token" placeholder="Token">

        <button id="btnSave" class="btn-primary">SAVE & REBOOT</button>
        <button id="btnBack" class="btn-secondary">Cancel</button>
    </div>

</div>

<script>
    // UUIDs must match main.cpp
    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHAR_SETTINGS = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const CHAR_SCAN = "1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e";
    const CHAR_CMD = "748db82d-2276-440c-a25c-2562945b4270";
    const CHAR_LIVE = "d05f38b4-0469-4d0c-9bc4-245745c05f53"; // Live Telemetry

    let device, server, service;
    let settingsChar, cmdChar;

    // UI References
    const screens = {
        connect: document.getElementById('connectScreen'),
        dashboard: document.getElementById('dashboardScreen'),
        config: document.getElementById('configScreen')
    };

    function showScreen(name) {
        Object.values(screens).forEach(s => s.classList.add('hidden'));
        screens[name].classList.remove('hidden');
    }

    // --- CONNECT LOGIC ---
    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            document.getElementById('statusMsg').innerText = "Searching...";
            
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'NUE_TREVOR_SETUP' }],
                optionalServices: [SERVICE_UUID]
            });

            device.addEventListener('gattserverdisconnected', onDisconnected);
            server = await device.gatt.connect();
            service = await server.getPrimaryService(SERVICE_UUID);

            // 1. Setup Live Data Listener
            const liveChar = await service.getCharacteristic(CHAR_LIVE);
            await liveChar.startNotifications();
            liveChar.addEventListener('characteristicvaluechanged', handleLiveData);

            // 2. Prepare Config Chars
            settingsChar = await service.getCharacteristic(CHAR_SETTINGS);
            cmdChar = await service.getCharacteristic(CHAR_CMD);

            // 3. Go to Dashboard
            showScreen('dashboard');

        } catch (error) {
            console.error(error);
            document.getElementById('statusMsg').innerText = "Error: " + error.message;
        }
    });

    // --- LIVE DATA HANDLER ---
    function handleLiveData(event) {
        const value = event.target.value;
        const jsonStr = new TextDecoder().decode(value);
        
        // Clean null bytes just in case
        const cleanStr = jsonStr.replace(/\0/g, '').trim();
        
        try {
            const data = JSON.parse(cleanStr);
            
            // Update Dashboard UI
            document.getElementById('val_v').innerText = data.v ? data.v.toFixed(1) : "--";
            document.getElementById('val_soc').innerText = data.soc || "--";
            document.getElementById('val_gps').innerText = data.gps || "Searching...";
            document.getElementById('val_net').innerText = (data.net || "Init") + " [" + (data.mac || "") + "]";
            
            if(data.alarm) {
                document.getElementById('statusBadge').innerText = "‚ö†Ô∏è ALARM";
                document.getElementById('statusBadge').style.background = "red";
            } else {
                document.getElementById('statusBadge').innerText = "ONLINE";
                document.getElementById('statusBadge').style.background = "#00d2ff";
            }

        } catch(e) { console.log("JSON Error:", e); }
    }

    // --- SETTINGS LOGIC ---
    document.getElementById('btnSettings').addEventListener('click', async () => {
        showScreen('config');
        
        // Load Scan List
        const scanChar = await service.getCharacteristic(CHAR_SCAN);
        const scanVal = await scanChar.readValue();
        const scanJson = new TextDecoder().decode(scanVal).replace(/\0/g, '').trim();
        populateBmsList(JSON.parse(scanJson));

        // Load Current Settings
        const setVal = await settingsChar.readValue();
        const setJson = JSON.parse(new TextDecoder().decode(setVal).replace(/\0/g, '').trim());
        
        document.getElementById('apn').value = setJson.apn || "";
        document.getElementById('token').value = setJson.token || "";
        document.getElementById('bmsList').value = setJson.mac || "";
    });

    document.getElementById('btnBack').addEventListener('click', () => {
        showScreen('dashboard');
    });

    function populateBmsList(devices) {
        const select = document.getElementById('bmsList');
        select.innerHTML = "<option value=''>-- Select Battery --</option>";
        devices.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.mac;
            opt.text = `${d.name} (${d.rssi} dBm)`;
            select.add(opt);
        });
    }

    document.getElementById('btnSave').addEventListener('click', async () => {
        const newSettings = {
            apn: document.getElementById('apn').value,
            token: document.getElementById('token').value,
            mac: document.getElementById('bmsList').value
        };

        try {
            const encoder = new TextEncoder();
            await settingsChar.writeValue(encoder.encode(JSON.stringify(newSettings)));
            await cmdChar.writeValue(encoder.encode("REBOOT"));
            alert("Saved! Trevor is rebooting.");
            window.location.reload();
        } catch(e) {
            alert("Error saving: " + e.message);
        }
    });

    function onDisconnected() {
        showScreen('connect');
        document.getElementById('statusMsg').innerText = "Disconnected from Trevor.";
    }
</script>

</body>
</html>