<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUE Trevor Pro</title>
    <style>
        /* ... (Styles can remain the same as previous version) ... */
        body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; text-align: center; }
        .container { max-width: 400px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 15px; }
        h1 { color: #00d2ff; }
        .card { background: #2c2c2c; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cell-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 0.8em; }
        .cell { background: #333; padding: 5px; border-radius: 4px; }
        .hidden { display: none; }
        button { background: #00d2ff; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .alarm { color: red; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="connectScreen">
        <h1>NUE TREVOR</h1>
        <p>Professional Diagnostic Tool</p>
        <button id="btnConnect">CONNECT</button>
        <p id="statusMsg"></p>
    </div>

    <div id="dashboardScreen" class="hidden">
        <h1>DASHBOARD</h1>
        <div class="grid">
            <div class="card">V: <b id="v">--</b></div>
            <div class="card">I: <b id="i">--</b></div>
            <div class="card">SOC: <b id="soc">--</b>%</div>
            <div class="card">CYC: <b id="cyc">--</b></div>
        </div>
        
        <div class="card">
            <div>GPS: <span id="gps">--</span></div>
            <div style="font-size:0.8em; color:#888;" id="loc"></div>
        </div>

        <div class="card">
            <h3>CELL VOLTAGES</h3>
            <div id="cells" class="cell-grid">Loading...</div>
        </div>

        <div class="card">
            <h3>ALARMS</h3>
            <div id="alarms">None</div>
        </div>

        <button onclick="location.reload()">DISCONNECT</button>
    </div>
</div>

<script>
    const SVC_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHAR_FAST = "d05f38b4-0469-4d0c-9bc4-245745c05f53";
    const CHAR_DETAIL = "e23e78a0-4e6c-4e27-b2f3-4e2342349122";

    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            document.getElementById('statusMsg').innerText = "Connecting...";
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'NUE_TREVOR_SETUP' }],
                optionalServices: [SVC_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SVC_UUID);

            // Setup Fast Data
            const fastChar = await service.getCharacteristic(CHAR_FAST);
            await fastChar.startNotifications();
            fastChar.addEventListener('characteristicvaluechanged', handleFast);

            // Setup Detail Data
            const detailChar = await service.getCharacteristic(CHAR_DETAIL);
            await detailChar.startNotifications();
            detailChar.addEventListener('characteristicvaluechanged', handleDetail);

            document.getElementById('connectScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
        } catch(e) {
            document.getElementById('statusMsg').innerText = e.message;
        }
    });

    function handleFast(e) {
        const d = JSON.parse(new TextDecoder().decode(e.target.value).replace(/\0/g, '').trim());
        document.getElementById('v').innerText = d.v.toFixed(1) + "V";
        document.getElementById('i').innerText = d.i.toFixed(1) + "A";
        document.getElementById('soc').innerText = d.soc;
        document.getElementById('gps').innerText = d.gps ? "FIXED" : "SEARCHING";
        if(d.lat) document.getElementById('loc').innerText = d.lat.toFixed(4) + ", " + d.lon.toFixed(4);
    }

    function handleDetail(e) {
        const d = JSON.parse(new TextDecoder().decode(e.target.value).replace(/\0/g, '').trim());
        document.getElementById('cyc').innerText = d.cyc;
        
        // Cells
        if(d.cel) {
            const cells = d.cel.split(',').filter(x => x);
            const div = document.getElementById('cells');
            div.innerHTML = "";
            cells.forEach((v, i) => {
                div.innerHTML += `<div class="cell">${i+1}: ${v}</div>`;
            });
        }

        // Alarms
        if(d.al) {
            const alDiv = document.getElementById('alarms');
            let active = [];
            if(d.al.ov) active.push("Cell Overvolt");
            if(d.al.uv) active.push("Cell Undervolt");
            if(d.al.sc) active.push("Short Circuit");
            if(d.al.doc) active.push("Dischg Overcurrent");
            // ... add others
            
            if(active.length > 0) {
                alDiv.innerHTML = active.map(a => `<div class="alarm">${a}</div>`).join("");
            } else {
                alDiv.innerHTML = "<span style='color:green'>System Healthy</span>";
            }
        }
    }
</script>
</body>
</html>
