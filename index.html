<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUE Trevor Pro</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #121212; color: #eee; padding: 20px; display: flex; justify-content: center; margin: 0; }
        .container { width: 100%; max-width: 400px; background: #1e1e1e; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        h1 { color: #00d2ff; margin: 0 0 15px 0; text-align: center; letter-spacing: 1px; }
        
        /* Grid Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-top: 5px; }
        
        .card { background: #2c2c2c; padding: 15px; border-radius: 8px; text-align: center; }
        
        /* Typography */
        .label { display: block; font-size: 0.7rem; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .value { font-size: 1.3rem; font-weight: bold; color: #fff; }
        .value-sm { font-size: 1.0rem; font-weight: bold; color: #fff; }
        .unit { font-size: 0.8rem; color: #888; font-weight: normal; }
        
        /* Specific Colors */
        .good { color: #00d2ff; }
        .bad { color: #ff4444; }
        
        /* GPS Link */
        #mapLink { color: #00d2ff; text-decoration: none; font-size: 0.85rem; font-weight: bold; display: none; margin-top: 8px; border: 1px solid #00d2ff; padding: 5px; border-radius: 4px; }
        
        /* Buttons */
        .hidden { display: none; }
        button { width: 100%; background: #00d2ff; border: none; padding: 12px; border-radius: 8px; font-weight: bold; font-size: 1rem; margin-top: 15px; cursor: pointer; color: #000; }
        button:active { opacity: 0.8; }
        
        .alarm { color: #ff4444; font-weight: bold; background: rgba(255,0,0,0.1); padding: 5px; border-radius: 4px; margin-top: 5px;}
        .healthy { color: #00d2ff; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="connectScreen">
        <h1>NUE TREVOR</h1>
        <p style="text-align:center; color:#888;">Pro Diagnostic Tool</p>
        <button id="btnConnect">CONNECT VIA BLUETOOTH</button>
        <p id="statusMsg" style="text-align:center; color:#666; margin-top:20px; font-size:0.8rem;">Ready</p>
    </div>

    <div id="dashboardScreen" class="hidden">
        <h1>DASHBOARD</h1>
        
        <div class="grid">
            <div class="card">
                <span class="label">Voltage</span>
                <span id="v" class="value">--</span> <span class="unit">V</span>
            </div>
            <div class="card">
                <span class="label">Current</span>
                <span id="i" class="value">--</span> <span class="unit">A</span>
            </div>
        </div>
        
        <div class="card" style="margin-bottom:10px;">
             <span class="label">STATE OF CHARGE</span>
             <span id="soc" class="value" style="font-size: 2rem;">--</span> <span class="unit">%</span>
        </div>
        
        <div class="card">
            <span class="label" style="margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px;">BATTERY HEALTH</span>
            <div class="grid-4">
                <div>
                    <span class="label">LOW</span>
                    <div id="c_min" class="value-sm">--</div>
                </div>
                <div>
                    <span class="label">HIGH</span>
                    <div id="c_max" class="value-sm">--</div>
                </div>
                <div>
                    <span class="label">AVG</span>
                    <div id="c_avg" class="value-sm">--</div>
                </div>
                <div>
                    <span class="label">CYCLES</span>
                    <div id="cyc" class="value-sm" style="color:#ffcc00">--</div>
                </div>
            </div>
            <div style="margin-top:10px; font-size:0.8rem; color:#888;">
                Delta: <span id="c_delta" style="color:#fff; font-weight:bold;">--</span> V
            </div>
        </div>

        <div class="card" style="margin-top:10px;">
            <span class="label">GPS LOCATION</span>
            <div id="gps" style="font-weight:bold; margin-bottom:2px;">Searching...</div>
            <div id="loc" style="font-size:0.8rem; color:#888;"></div>
            <a id="mapLink" href="#" target="_blank">OPEN MAP â†—</a>
        </div>

        <div class="card" style="margin-top:10px;">
            <span class="label">SYSTEM STATUS</span>
            <div id="alarms"><span class="healthy">System Healthy</span></div>
        </div>

        <button onclick="location.reload()" style="background:#333; color:#fff;">DISCONNECT</button>
    </div>
</div>

<script>
    const SVC_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHAR_FAST = "d05f38b4-0469-4d0c-9bc4-245745c05f53";
    const CHAR_DETAIL = "e23e78a0-4e6c-4e27-b2f3-4e2342349122";

    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            document.getElementById('statusMsg').innerText = "Scanning...";
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'NUE_TREVOR_SETUP' }],
                optionalServices: [SVC_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SVC_UUID);

            // Subscribe to Fast Data (1s)
            const fastChar = await service.getCharacteristic(CHAR_FAST);
            await fastChar.startNotifications();
            fastChar.addEventListener('characteristicvaluechanged', handleFast);

            // Subscribe to Detail Data (4s)
            const detailChar = await service.getCharacteristic(CHAR_DETAIL);
            await detailChar.startNotifications();
            detailChar.addEventListener('characteristicvaluechanged', handleDetail);

            document.getElementById('connectScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');
        } catch(e) {
            document.getElementById('statusMsg').innerText = "Error: " + e.message;
        }
    });

    function handleFast(e) {
        const clean = new TextDecoder().decode(e.target.value).replace(/\0/g, '').trim();
        try {
            const d = JSON.parse(clean);
            document.getElementById('v').innerText = d.v ? d.v.toFixed(1) : "--";
            document.getElementById('i').innerText = d.i ? d.i.toFixed(1) : "--";
            document.getElementById('soc').innerText = d.soc || "--";
            
            const gpsStatus = d.gps ? "FIXED" : "SEARCHING";
            document.getElementById('gps').innerText = "GPS: " + gpsStatus;
            
            if(d.lat && d.lon && d.lat !== 0) {
                document.getElementById('loc').innerText = d.lat.toFixed(4) + ", " + d.lon.toFixed(4);
                const link = document.getElementById('mapLink');
                link.href = `https://maps.google.com/?q=${d.lat},${d.lon}`;
                link.style.display = "inline-block"; 
            }
        } catch(err) { console.error(err); }
    }

    function handleDetail(e) {
        const clean = new TextDecoder().decode(e.target.value).replace(/\0/g, '').trim();
        try {
            const d = JSON.parse(clean);
            document.getElementById('cyc').innerText = d.cyc || "--";
            
            // CALCULATE CELL STATS
            if(d.cel) {
                // Convert string "3.2,3.1,..." to array of numbers
                const cells = d.cel.split(',').filter(x => x).map(Number);
                
                if(cells.length > 0) {
                    const min = Math.min(...cells);
                    const max = Math.max(...cells);
                    const avg = cells.reduce((a,b) => a+b, 0) / cells.length;
                    const delta = max - min;

                    document.getElementById('c_min').innerText = min.toFixed(3);
                    document.getElementById('c_max').innerText = max.toFixed(3);
                    document.getElementById('c_avg').innerText = avg.toFixed(3);
                    
                    const deltaEl = document.getElementById('c_delta');
                    deltaEl.innerText = delta.toFixed(3);
                    
                    // Highlight bad delta (> 100mV)
                    if(delta > 0.100) deltaEl.style.color = "#ff4444";
                    else deltaEl.style.color = "#00d2ff";
                }
            }

            // Update Alarms
            if(d.al) {
                const alDiv = document.getElementById('alarms');
                let active = [];
                if(d.al.ov) active.push("Cell Overvolt");
                if(d.al.uv) active.push("Cell Undervolt");
                if(d.al.sc) active.push("Short Circuit");
                if(d.al.cot) active.push("Charge Temp High");
                if(d.al.cut) active.push("Charge Temp Low");
                if(d.al.doc) active.push("Discharge Overcurrent");
                
                if(active.length > 0) {
                    alDiv.innerHTML = active.map(a => `<div class="alarm">${a}</div>`).join("");
                } else {
                    alDiv.innerHTML = "<span class='healthy'>System Healthy</span>";
                }
            }
        } catch(err) { console.error(err); }
    }
</script>
</body>
</html>
